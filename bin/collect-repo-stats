#!/usr/bin/env node
const repo = require("../lib/repo");
const program = require('commander');
const fs = require('fs');
const colors = require('colors/safe');

program
  .option('-u, --user [username]', 'Get repos for user')
  .option('-o, --output [file]', 'JSON file containing the statistics for each repo')
  .option('--from [num]', 'Index of oldest repo to start from')
  .option('--to [num]', 'Index of oldest repo to stop')
  .option('--concurrency [num]', 'How many requests to send in parallel')
  .parse(process.argv);

if(!process.env.GITHUB_ACCESS_TOKEN) {
  console.error('GITHUB_ACCESS_TOKEN not set to a valid GitHub access token')
  program.outputHelp();
}

if (program.user && program.output) {
  repo.getAllUserRepoStats(program.user, parseInt(program.concurrency || 1), program.from, program.to, (err, repo) => {
    if(err) {
      if(err) {
        console.error(colors.red(`${repo.owner.login}/${repo.name} failed ${err}`));
        if(err.stack) console.error(colors.red(firstError.stack));
      }
    } else {
      fs.appendFile(program.output, JSON.stringify(repo) + '\n', (err) => {
        if (err) throw err;
        console.log(colors.green(`${repo.owner}/${repo.name} saved stats`));
      });
    }
  }, (err, repos) => {
    if (err) throw err;
    console.log('Finished collecting stats for', repos.length, 'repos');
  });
} else {
  program.outputHelp();
}
